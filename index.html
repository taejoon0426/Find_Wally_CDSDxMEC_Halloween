<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Find Wally with AI - [CDSD x MEC]</title>
  <style>
    :root{
      --bg:#0b0b0b; --fg:#eaeaea; --muted:#9aa0a6;
      --accent:#ff4d4f; /* red */
      --success:#22c55e; /* green */
      --card:#111; --border:#222;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ margin:0; height:100%; background:var(--bg); color:var(--fg); font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; }

    /* ===== Header ===== */
    header{
      position:sticky; top:0; z-index:5;
      display:flex; align-items:center; gap:10px;
      padding: calc(10px + var(--safe-top)) 16px 12px;
      background:rgba(11,11,11,.9);
      backdrop-filter:saturate(120%) blur(6px);
      border-bottom:1px solid var(--border);
    }
    header img{ width:40px; height:40px; border-radius:8px; object-fit:cover; }
    header h1{ margin:0; font-size:17px; font-weight:800; letter-spacing:.2px; }

    /* ===== Layout ===== */
    main{ padding: 10px 12px 120px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:12px; box-shadow:0 8px 24px rgba(0,0,0,.25); }
    .stack{ display:flex; flex-direction:column; gap:12px; }

    /* ===== Camera ===== */
    .cameraWrap{ position:relative; }
    .cameraHint{
      position:absolute; left:12px; top:12px;
      background:rgba(0,0,0,.55);
      padding:6px 10px; border-radius:999px;
      font-size:12px; color:#eae9eb; border:1px solid #000;
      display:none;
    }
    canvas{
      width:100%;
      aspect-ratio: 1 / 1;
      border-radius:14px;
      background:#000;
      max-height: 75dvh;
      border: 3px solid #fff; /* ✅ 기본 흰색 */
      transition: border-color 160ms ease;
    }
    .success{ border-color: var(--success) !important; } /* ✅ 초록 */
    .fail{ border-color: var(--accent) !important; }     /* ❌ 빨강 */

    /* ===== Zoom ===== */
    .zoomWrap{
      margin-top:10px;
      display:none;
      align-items:center; gap:10px;
    }
    .zoomWrap .zoomLabel{ font-size:12px; color:#bdbdbd; min-width:40px; }
    .zoomWrap .zoomValue{ font-size:12px; color:#d1d5db; width:52px; text-align:right; font-variant-numeric: tabular-nums; }
    .zoomWrap input[type="range"]{
      -webkit-appearance:none; appearance:none;
      width:100%; height:30px; background:transparent;
    }
    .zoomWrap input[type="range"]::-webkit-slider-runnable-track{
      height:6px; background:#2a2a2a; border-radius:999px;
    }
    .zoomWrap input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none; appearance:none;
      width:18px; height:18px; border-radius:50%; background:#eaeaea; margin-top:-6px; border:1px solid #111;
    }

    /* ===== Status / Prob ===== */
    .statusLine{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .label{ color:var(--muted); font-size:13px; }
    .topBadge{ font-weight:800; font-size:14px; padding:6px 10px; border-radius:999px; border:1px solid #333; background:#151515; }
    .probs{ display:flex; flex-direction:column; gap:8px; }
    .row{ display:grid; grid-template-columns: 120px 1fr auto; gap:8px; align-items:center; }
    .name{ color:#d1d5db; font-weight:700; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .bar{ background:#1f1f1f; height:12px; border-radius:999px; overflow:hidden; border:1px solid #2a2a2a; }
    .bar>div{ height:100%; width:0%; background: linear-gradient(90deg,#3b82f6,#22d3ee,#a78bfa); transition: width 120ms ease; }
    .pct{ min-width:58px; text-align:right; color:#c9c9c9; font-variant-numeric: tabular-nums; font-size:13px; }

    /* ===== Controls ===== */
    .controls{
      position:fixed; left:0; right:0; bottom:0; z-index:10;
      background:rgba(15,15,15,.92); backdrop-filter:saturate(120%) blur(8px);
      border-top:1px solid var(--border);
      padding:10px 12px calc(10px + var(--safe-bottom));
    }
    .controlsInner{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; }
    button{
      appearance:none; border:1px solid #333; background:#181818; color:var(--fg);
      border-radius:12px; padding:14px 12px; font-weight:800; font-size:16px; cursor:pointer;
    }
    button:active{ transform:translateY(1px); }
    button[disabled]{ opacity:.5; pointer-events:none; }
    .accent{ background:#202020; border-color:#383838; }
    .danger{ background:#1e1e1e; border-color:#3a3a3a; }
    .switch{ background:#141414; border-color:#333; }

    footer{ text-align:center; color:#6b7280; padding:8px 0 12px; font-size:11px; }

    /* === Result message overlay (추가) === */
    .resultMsg{
      position:absolute; inset:0;
      display:flex; justify-content:center; align-items:center;
      background:rgba(0,0,0,.45); backdrop-filter:blur(4px);
      font-size:22px; font-weight:800; color:#eaeaea;
      border-radius:14px; opacity:0; pointer-events:none;
      transition:opacity .25s ease;
    }
    .resultMsg.show{ opacity:1; }
  </style>
</head>
<body>
  <header>
    <img src="cdsd_logo.png" alt="CDSD Logo" />
    <h1>Find Wally with AI - [CDSD x MEC]</h1>
  </header>

  <main>
    <div class="stack">
      <section class="card cameraWrap">
        <div class="cameraHint" id="cameraHint">Tip: Fill the frame with only WALLY</div>
        <div id="webcam-container"></div>

        <!-- ✅ 결과 메시지 오버레이 (추가) -->
        <div id="resultMsg" class="resultMsg"></div>

        <div id="zoomWrap" class="zoomWrap">
          <span class="zoomLabel">Zoom</span>
          <input id="zoom" type="range" min="1" max="1" step="0.1" value="1" />
          <span class="zoomValue" id="zoomVal">1.0×</span>
        </div>

        <div class="statusLine" style="margin-top:10px;">
          <div class="label" id="label">Waiting for camera...</div>
          <div class="topBadge" id="topBadge">Top: —</div>
        </div>
      </section>

      <section class="card">
        <h2 style="margin:0 0 10px 0; font-size:15px;">Live Probabilities</h2>
        <div class="probs" id="probs"></div>
      </section>
    </div>
  </main>

  <div class="controls">
    <div class="controlsInner">
      <button id="startBtn" class="accent">Start</button>
      <button id="stopBtn" class="danger" disabled>Stop</button>
      <button id="switchCamBtn" class="switch">Switch</button>
    </div>
    <div class="label" style="margin-top:6px;">NOTICE: If you allowed camera access, please tap the "Start" button again.</div>
  </div>

  <footer>Powered by TensorFlow.js + Teachable Machine</footer>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.4/dist/teachablemachine-image.min.js"></script>

  <script>
    const MODEL_URL = "./model/";
    const SUCCESS_THRESHOLD = 0.8; // 80%

    let model, webcam, maxPredictions, labels = [];
    let animId = null;
    let facingMode = localStorage.getItem("facingMode") || "user";
    let wakeLock = null;
    let currentTrack = null;
    let lastBest = { className:"", probability:0 };

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const switchCamBtn = document.getElementById("switchCamBtn");
    const probsEl = document.getElementById("probs");
    const labelEl = document.getElementById("label");
    const topBadgeEl = document.getElementById("topBadge");
    const cameraHintEl = document.getElementById("cameraHint");
    const zoomWrapEl = document.getElementById("zoomWrap");
    const zoomEl = document.getElementById("zoom");
    const zoomValEl = document.getElementById("zoomVal");
    const resultMsgEl = document.getElementById("resultMsg"); // ✅ 추가

    async function loadModel(){
      if(model) return;
      model = await tmImage.load(MODEL_URL+"model.json", MODEL_URL+"metadata.json");
      maxPredictions = model.getTotalClasses();
      labels = model.getClassLabels();
      probsEl.innerHTML = labels.map(n=>`
        <div class="row">
          <div class="name">${n}</div>
          <div class="bar"><div></div></div>
          <div class="pct">0.00%</div>
        </div>`).join("");
    }
    function setRow(i,p){
      const row = probsEl.children[i]; if(!row) return;
      row.querySelector(".bar>div").style.width = (p*100)+"%";
      row.querySelector(".pct").textContent = (p*100).toFixed(2)+"%";
    }

    function hideZoom(){ zoomWrapEl.style.display="none"; }
    function setupZoom(track){
      const caps = track.getCapabilities?.();
      if(!caps||!caps.zoom){ hideZoom(); return; }
      const min=caps.zoom.min, max=caps.zoom.max, step=caps.zoom.step||0.1;
      zoomEl.min=min; zoomEl.max=max; zoomEl.step=step;
      zoomWrapEl.style.display="flex";
      zoomEl.oninput=async()=>{
        zoomValEl.textContent=Number(zoomEl.value).toFixed(1)+"×";
        try{ await track.applyConstraints({advanced:[{zoom:parseFloat(zoomEl.value)}]}); }catch{}
      };
    }

    async function initWebcam(){
      await loadModel();
      if(animId) cancelAnimationFrame(animId);
      animId=null;
      if(webcam){ try{webcam.stop();}catch{} webcam=null; }

      const flip=(facingMode==="user");
      webcam=new tmImage.Webcam(480,480,flip);
      await webcam.setup({facingMode});
      await webcam.play();

      const cont=document.getElementById("webcam-container");
      cont.innerHTML=""; cont.appendChild(webcam.canvas);
      webcam.canvas.classList.remove("success","fail");
      cameraHintEl.style.display="block";

      const video=webcam.webcam;
      currentTrack=video.srcObject.getVideoTracks()[0];
      setupZoom(currentTrack);

      startBtn.disabled=true; stopBtn.disabled=false;
      labelEl.textContent="Predicting...";
      window.requestAnimationFrame(loop);
    }

    async function loop(){
      if(!webcam) return;
      webcam.update();
      const pred=await model.predict(webcam.canvas);
      pred.forEach((p,i)=>setRow(i,p.probability));
      lastBest=pred.reduce((a,b)=>a.probability>b.probability?a:b);
      topBadgeEl.textContent=`Top: ${lastBest.className} ${(lastBest.probability*100).toFixed(1)}%`;
      animId=requestAnimationFrame(loop);
    }

    // ✅ 결과 메시지 표시 함수 (추가)
    function showResultMessage(text, color){
      if(!resultMsgEl) return;
      resultMsgEl.textContent = text;
      resultMsgEl.style.color = color;
      resultMsgEl.classList.add("show");
      setTimeout(()=> resultMsgEl.classList.remove("show"), 2000); // 2초 후 자동 숨김
    }

    function stopWebcam(){
      if(animId) cancelAnimationFrame(animId);
      animId=null;
      if(webcam?.canvas){
        webcam.canvas.classList.remove("success","fail");
        if(lastBest.className==="Wally" && lastBest.probability>=SUCCESS_THRESHOLD){
          webcam.canvas.classList.add("success"); // ✅ 초록
          showResultMessage("🎉 Found Wally 🎉", "#22c55e"); // ✅ 메시지
        }else{
          webcam.canvas.classList.add("fail"); // ❌ 빨강
          showResultMessage("😭 Try again 😭", "#ff4d4f");   // ✅ 메시지
        }
      }
      if(webcam){ try{webcam.stop();}catch{} webcam=null; }
      startBtn.disabled=false; stopBtn.disabled=true;
      labelEl.textContent="Camera stopped.";
      cameraHintEl.style.display="none";
    }

    startBtn.onclick=initWebcam;
    stopBtn.onclick=stopWebcam;
    switchCamBtn.onclick=async()=>{
      facingMode=(facingMode==="user")?"environment":"user";
      await initWebcam();
    };
  </script>
</body>
</html>
